#!/usr/bin/env bash

set -eo pipefail


if [[ -z "$1" ]]; then
  echo "tmuxer {config}

    tmuxer config.toml"
  exit 1
fi

CONFIG=`realpath $1`

info() {
  printf "\033[0;34m$@\033[0m\n"
}

# get local network ip from default network interface 
LOCAL_IP() {
    local interfaces=$(ip link show up | grep -P "(?<=^[0-9]: )((enp)|(wlo)|(eth)|(wlp))[^:]*" -o)
    local routes=$(ip route show | grep -E '^default')
    local default=${interfaces[0]}
    for interface in $interfaces; do
        gateway=$(ip route show | grep -P "(?<=^default via )([0-9]|[.])*(?= dev $interface)" -o)
        if [[ "$gateway" != "" ]]; then
            default=$interface
            break
        fi
    done

    echo `ip a show dev $default | grep 'inet' | awk '{print $2}' | head -n 1 | cut -d '/' -f1`
}

OS() {
  uname
}

WAIT_ON_PORT() {
  local port=$1
  while ! nc -z localhost 88; do sleep 0.1; done
}

HOSTNAME() {
  if [[ "$(os)" == "Linux" ]]; then
      hostname=$(hostname -I)
      printf "It's probably but make sure\n"
  elif [[ "$(os)" == "Darwin" ]]; then
      hostname=$(ipconfig getifaddr en0)
      printf "It's probably $hostname but make sure\n"
  else
      printf "Unable to determine the OS\n"
  fi
}

get_value() {
  local key=$1
  local property=$2
  local req=$3
  local value=`tomlq -r ".[\"$key\"].$property" $CONFIG`
  if [[ "$req" != "" ]] && [[ "$value" == null ]]; then
    >&2 echo "toml value '$key.$property' is null"
    exit 1
  fi
  echo $value
}

if ! which yq >/dev/null; then
  info "Please install https://github.com/kislyuk/yq"
  exit 1
fi

keys=(`tomlq -r 'keys[]' $1`);
for key in "${keys[@]}"; do
  path=$(get_value $key path req)
  path=`realpath $path`
  repo=$(get_value $key repo req)
  exec=$(get_value $key exec)

  cd $path

  execnow=$(get_value $key execnow)
  if [[ $execnow != null ]]; then
    echo $execnow
    eval $execnow
    continue
  fi

  if [ ! -d $path ]; then
    info "cloning to $path"
    git clone --recursive $repo $path
  fi
  
  info "Setting up $key on $path"
  # tmux new-session -c $path -d -s $key
  # tmux split-window -v -t $key
  # tmux send-keys -t $key.1 'echo "test"' C-m
done
